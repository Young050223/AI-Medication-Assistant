# 🏛️ AI用药助手 - 项目宪法 (Project Constitution)

> **版本**: v1.1.0  
> **创建日期**: 2026-01-17  
> **最后更新**: 2026-01-30

---

## 第一章：项目使命与边界

### 第一条：核心使命
本项目旨在帮助用户追踪医院外的日常用药情况，通过AI Agent提供用药建议、禁忌警告和用药反馈，同时为医生提供患者院外用药情况汇总。

### 第二条：目标用户群体
1. **老人** - 用户
2. **子女及NGO和养老院** - 家庭账户

### 第三条：功能边界（严禁越界）

#### ✅ 允许的功能范围
| 编号 | 功能模块 | 描述 |
|------|----------|------|
| F1 | 病例识别 | 识别电子/纸质病例截图，提取用药信息；支持拍药盒/输入药名 |
| F2 | 服药周期追踪 | 每个药的服药周期和进度，极简交互确认服药状态，有明确的按钮确认服药完成 |
| F3 | 服药反馈 | 患者通过文字/语音描述服药感受，系统保存 |
| F4 | 医生报告 | 根据药物说明书或医生处方的指引（比如，7天后未见效需停止服药或咨询医生），阶段性生成用药历史和感受总结，供医生查看 |
| F5 | 健康档案 | 基本信息、过往病史、过敏药物 |
| F6 | AI分析预警 | 药物重复/过量/冲突/禁忌预警（含食物/饮品禁忌），预留大模型接口 |
| F7 | 多语言 | 简体中文、繁体中文、英文，提供全局语言切换按钮，使用i18n |
| F8 | 老年友好UI | 简洁直观的界面设计 |
| F9 | 隐私安全 | 敏感医疗数据仅本地加密存储，用户主动分享时点对点端到端加密 |
| F10 | 家庭账户 | 支持多用户管理 |
| F11 | 付费预留 | 预留付费功能接口 |

#### ❌ 禁止的功能范围
- 任何形式的医疗诊断功能
- 处方开具功能
- 药物购买/电商功能
- 与医院系统的直接对接（除非明确授权）

### 第四条：AI知识来源限制
AI Agent调用的知识来源**仅限**：
1. 药物说明书（由你提供的API输出）
2. 核心期刊论文（由你提供的API输出）
3. 政府指引（由你提供的API输出）
4. 预留医疗大模型接口

> [!CAUTION]
> 禁止使用未经授权的第三方医疗数据源，禁止公开抓取

---

## 第二章：技术路线约束

### 第五条：平台开发顺序
1. **第一阶段**: iOS先行，Capacitor + React 承担主要业务逻辑
2. **第二阶段**: iOS原生能力补充（Swift/SwiftUI）
3. **第三阶段**: 视情况使用Capacitor同步开发其他平台

### 第六条：技术栈强制要求
| 层级 | 技术选型 | 备注 |
|------|----------|------|
| 跨平台框架 | Capacitor | 必须使用 |
| 后端服务 | Supabase | 必须使用 |
| 数据管理 | Supabase + 表结构（非敏感）+ 本地加密存储（敏感） | 必须使用 |
| 国际化 | i18n | 必须使用 |
| 前端框架 | React | 必须使用（Capacitor Web UI） |
| 前端架构 | 模块化Hooks | 必须遵循 |
| iOS原生能力 | Swift/SwiftUI | 仅用于原生能力/插件 |

### 第七条：技术选型变更流程
任何技术选型的变更必须：
1. 提出书面变更申请
2. 说明变更原因和影响评估
3. 获得项目负责人批准

---

## 第三章：验收标准 (Definition of Done)

> [!IMPORTANT]
> 此条款为项目核心原则，必须严格执行

### 第八条：模块验收标准 (DOD)
每个功能模块在开发完成后，**必须满足以下全部条件**才能进入下一模块开发：

#### 8.1 代码层面
- [ ] 代码能够成功编译，无编译错误
- [ ] 所有单元测试通过
- [ ] 代码符合模块化Hooks规范
- [ ] 注释完整且可读
- [ ] 需要我亲自在IOS模拟器中跑通

#### 8.2 功能层面
- [ ] 功能在iOS模拟器/真机上能正常运行
- [ ] 核心用户流程可完整走通
- [ ] 无阻塞性(Blocking)Bug

#### 8.3 集成层面
- [ ] 与已完成模块无冲突
- [ ] API接口正常调用
- [ ] 数据存储和读取正常

### 第九条：验收流程
```
开发完成 → 自测通过 → 模拟器运行验证 → 功能确认 → 进入下一模块
    ↑                                        ↓
    └──────────── 不通过则返回修复 ──────────┘
```

### 第十条：阻塞原则
- 当前模块未通过验收前，**禁止**开始下一模块开发
- 发现阻塞性问题必须**立即修复**
- 模块进度需在开发日志中实时更新

---

## 第三章B：模块间数据同步规范

> [!IMPORTANT]
> 此章节基于实际开发过程中的问题复盘总结，必须严格遵守

### 第十条B：共享数据的页面组件规范

#### 问题复盘 (2026-01-30)
**问题现象**：在"用药提醒"页面创建服药计划后，返回"首页"时数据未更新
**修改次数**：多次修改后才定位到真正原因
**根本原因**：

```
LandingPage                    MedicationSchedulePage
    │                                   │
    ▼                                   ▼
useMedicationSchedule()        useMedicationSchedule()
    │                                   │
    ▼                                   ▼
[独立的 schedules 状态]        [独立的 schedules 状态]  ← 状态隔离！
```

两个页面各自调用同一个 Hook，产生**独立的状态实例**。当一个页面修改数据并保存到 Supabase 后，另一个页面的状态不会自动更新。

#### 定位问题的正确方法

1. **识别交互模块** - 首先确定哪些页面/组件需要共享同一份数据
2. **检查状态来源** - 确认数据是本地状态还是远程数据(Supabase)
3. **验证同步机制** - 检查页面切换时是否有数据刷新逻辑

#### 解决方案

**方案一：页面挂载时刷新数据（当前采用）**
```tsx
// 在需要最新数据的页面组件中
const { loadSchedules, ... } = useMedicationSchedule();

useEffect(() => {
    loadSchedules(); // 每次进入页面都重新加载
}, [loadSchedules]);
```

**方案二：使用全局状态管理（适合复杂场景）**
- React Context + useReducer
- 或第三方状态库（Zustand/Redux）

#### 强制规范

| 规范 | 描述 |
|------|------|
| **识别共享数据模块** | 开发前明确哪些页面需要同一份数据 |
| **页面切换刷新** | 返回页面时必须触发数据刷新 |
| **Hook 设计** | 共享数据的 Hook 必须暴露 `loadXxx()` 方法供页面调用 |
| **测试验证** | 必须测试"修改数据 → 切换页面 → 查看是否同步" |

#### 常见陷阱

1. **假设 Hook 状态共享** - 每个组件调用 Hook 都是独立实例
2. **只测试单页面** - 必须测试跨页面的数据同步
3. **依赖缓存** - 页面切换时不能依赖旧缓存

---

## 第四章：交互流程规范

### 第十一条：核心用户流程
```
进入App → 注册/登录 → 完成健康档案 → 上传病例信息 → AI分析 → 用药计划 → 用药分析 → 存入本地（非敏感数据可同步Supabase）
                        ↓
              (拍照/图片/语音/文字)
```

> [!IMPORTANT]
> 上传病例前必须完成健康档案

### 第十二条：用户体验原则
1. **极简交互** - 特别是服药确认，一键完成
2. **老年友好** - 大字体、高对比度、简洁布局
3. **无障碍设计** - 支持语音输入和反馈

---

## 第五章：数据与隐私

### 第十三条：数据存储原则
1. **敏感医疗数据仅本地** - 健康档案/用药记录/反馈/报告仅存终端
2. **本地加密** - 设备内加密存储
3. **端到端加密** - 仅用于用户主动分享/导出（点对点）

### 第十四条：数据同步策略
- 非敏感数据：Supabase云端同步（账号、配置、订阅等）
- 敏感医疗数据：仅本地加密存储，不上云
- 分享/导出：用户主动触发，端到端加密点对点传输（不在云端持久化）

---

## 第六章：修订与解释

### 第十五条：宪法修订
本宪法的任何修订需经项目负责人书面批准。

### 第十六条：解释权
本宪法的最终解释权归项目负责人所有。

---

**签署确认**：  
项目负责人：_______________  
日期：2026年01月17日
